{% extends "base.html" %}

{% block content %}
<h2>Playground</h2>

<div class="card">
    <div style="margin-bottom: 1rem;">
        <label for="template-select">Sélectionner un template</label>
        <select id="template-select" style="width: 100%; padding: 0.5rem; box-sizing: border-box;">
            <option value="">Choisir un template</option>
            {% for t in templates %}
            <option value="{{ t.id }}" {% if selected_template and selected_template.id == t.id %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div id="template-info" style="margin-bottom: 1rem; display: {% if selected_template %}block{% else %}none{% endif %};">
        <p id="template-description">{% if selected_template %}{{ selected_template.description }}{% endif %}</p>
        <div>
            <span class="tag" id="template-category">{% if selected_template %}{{ selected_template.category }}{% endif %}</span>
            {% if selected_template %}
                {% for tag in selected_template.tags %}
                <span class="tag">{{ tag }}</span>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</div>

<div id="variables-container" class="card" style="display: {% if selected_template %}block{% else %}none{% endif %};">
    <h3>Variables</h3>
    <div id="variables-form">
        {% if selected_template and selected_template.variables %}
            {% for var in selected_template.variables %}
            <div class="variable-input" style="margin-bottom: 1rem;">
                <label for="var-{{ var.name }}">{{ var.name }}</label>
                {% if var.description %}<p style="margin-top: 0; margin-bottom: 0.5rem; color: #666; font-size: 0.9em;">{{ var.description }}</p>{% endif %}
                
                {% if var.type == "string" or var.type == "integer" or var.type == "float" %}
                <input type="text" id="var-{{ var.name }}" data-name="{{ var.name }}" data-type="{{ var.type }}" 
                       placeholder="{% if var.example %}Exemple: {{ var.example }}{% endif %}" 
                       {% if var.default %}value="{{ var.default }}"{% endif %}
                       style="width: 100%; padding: 0.5rem; box-sizing: border-box;">
                
                {% elif var.type == "boolean" %}
                <select id="var-{{ var.name }}" data-name="{{ var.name }}" data-type="{{ var.type }}" style="width: 100%; padding: 0.5rem; box-sizing: border-box;">
                    <option value="true" {% if var.default == true %}selected{% endif %}>Vrai</option>
                    <option value="false" {% if var.default == false %}selected{% endif %}>Faux</option>
                </select>
                
                {% elif var.type == "code" %}
                <textarea id="var-{{ var.name }}" data-name="{{ var.name }}" data-type="{{ var.type }}" rows="5" 
                          placeholder="{% if var.example %}{{ var.example }}{% endif %}"
                          style="width: 100%; padding: 0.5rem; font-family: monospace; box-sizing: border-box;">{% if var.default %}{{ var.default }}{% endif %}</textarea>
                
                {% elif var.options %}
                <select id="var-{{ var.name }}" data-name="{{ var.name }}" data-type="{{ var.type }}" style="width: 100%; padding: 0.5rem; box-sizing: border-box;">
                    {% for option in var.options %}
                    <option value="{{ option }}" {% if var.default == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
                
                {% else %}
                <input type="text" id="var-{{ var.name }}" data-name="{{ var.name }}" data-type="{{ var.type }}" 
                       placeholder="{% if var.example %}Exemple: {{ var.example }}{% endif %}" 
                       {% if var.default %}value="{{ var.default }}"{% endif %}
                       style="width: 100%; padding: 0.5rem; box-sizing: border-box;">
                {% endif %}
            </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<div class="card" style="display: {% if selected_template %}flex{% else %}none{% endif %}; gap: 1rem; margin-bottom: 1rem;">
    <div style="flex: 1;">
        <label for="provider-select">Fournisseur LLM</label>
        <select id="provider-select" style="width: 100%; padding: 0.5rem; box-sizing: border-box;">
            <option value="">Défaut</option>
            {% for provider in providers %}
            <option value="{{ provider }}">{{ provider }}</option>
            {% endfor %}
        </select>
    </div>
    <div style="flex: 2; display: flex; align-items: flex-end;">
        <button id="generate-button" class="btn">Générer le prompt</button>
    </div>
</div>

<div class="card">
    <h3>Prompt généré</h3>
    <pre id="result" style="white-space: pre-wrap; background-color: #f8f8f8; padding: 1rem; border-radius: 4px; min-height: 100px;">Sélectionnez un template et remplissez les variables pour générer un prompt</pre>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const templateSelect = document.getElementById('template-select');
        const templateInfo = document.getElementById('template-info');
        const templateDescription = document.getElementById('template-description');
        const templateCategory = document.getElementById('template-category');
        const variablesContainer = document.getElementById('variables-container');
        const variablesForm = document.getElementById('variables-form');
        const generateButton = document.getElementById('generate-button');
        const providerSelect = document.getElementById('provider-select');
        const resultElement = document.getElementById('result');
        
        // Fonction pour charger un template
        function loadTemplate(templateId) {
            if (!templateId) {
                templateInfo.style.display = 'none';
                variablesContainer.style.display = 'none';
                return;
            }
            
            fetch(`/prompts/templates/${templateId}`)
                .then(response => response.json())
                .then(template => {
                    // Mettre à jour les informations du template
                    templateDescription.textContent = template.description;
                    templateCategory.textContent = template.category;
                    
                    // Mettre à jour les variables
                    variablesForm.innerHTML = '';
                    if (template.variables && template.variables.length > 0) {
                        template.variables.forEach(variable => {
                            const varDiv = document.createElement('div');
                            varDiv.className = 'variable-input';
                            varDiv.style.marginBottom = '1rem';
                            
                            let inputHtml = '';
                            if (variable.type === 'code') {
                                inputHtml = `<textarea id="var-${variable.name}" data-name="${variable.name}" data-type="${variable.type}" rows="5" 
                                             placeholder="${variable.example ? variable.example : ''}"
                                             style="width: 100%; padding: 0.5rem; font-family: monospace; box-sizing: border-box;">${variable.default || ''}</textarea>`;
                            } else if (variable.type === 'boolean') {
                                inputHtml = `
                                    <select id="var-${variable.name}" data-name="${variable.name}" data-type="${variable.type}" style="width: 100%; padding: 0.5rem; box-sizing: border-box;">
                                        <option value="true" ${variable.default === true ? 'selected' : ''}>Vrai</option>
                                        <option value="false" ${variable.default === false ? 'selected' : ''}>Faux</option>
                                    </select>`;
                            } else if (variable.options && variable.options.length) {
                                let options = variable.options.map(opt => 
                                    `<option value="${opt}" ${variable.default === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('');
                                
                                inputHtml = `
                                    <select id="var-${variable.name}" data-name="${variable.name}" data-type="${variable.type}" style="width: 100%; padding: 0.5rem; box-sizing: border-box;">
                                        ${options}
                                    </select>`;
                            } else {
                                inputHtml = `<input type="text" id="var-${variable.name}" data-name="${variable.name}" data-type="${variable.type}" 
                                           placeholder="${variable.example ? 'Exemple: ' + variable.example : ''}" 
                                           value="${variable.default || ''}"
                                           style="width: 100%; padding: 0.5rem; box-sizing: border-box;">`;
                            }
                            
                            varDiv.innerHTML = `
                                <label for="var-${variable.name}">${variable.name}</label>
                                ${variable.description ? `<p style="margin-top: 0; margin-bottom: 0.5rem; color: #666; font-size: 0.9em;">${variable.description}</p>` : ''}
                                ${inputHtml}
                            `;
                            
                            variablesForm.appendChild(varDiv);
                        });
                    }
                    
                    // Afficher les sections
                    templateInfo.style.display = 'block';
                    variablesContainer.style.display = 'block';
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du template:', error);
                    alert('Erreur lors du chargement du template');
                });
        }
        
        // Fonction pour générer le prompt
        function generatePrompt() {
            const templateId = templateSelect.value;
            if (!templateId) {
                alert('Veuillez sélectionner un template');
                return;
            }
            
            // Récupérer les valeurs des variables
            const variables = {};
            const inputs = variablesForm.querySelectorAll('[data-name]');
            inputs.forEach(input => {
                const name = input.dataset.name;
                const type = input.dataset.type;
                let value = input.value;
                
                // Convertir selon le type
                if (type === 'integer') {
                    value = parseInt(value);
                } else if (type === 'float') {
                    value = parseFloat(value);
                } else if (type === 'boolean') {
                    value = value === 'true';
                }
                
                variables[name] = value;
            });
            
            // Appeler l'API pour formater le prompt
            const provider = providerSelect.value || undefined;
            
            fetch(`/prompts/templates/${templateId}/format`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    variables: variables,
                    provider: provider
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.formatted_prompt) {
                    resultElement.textContent = data.formatted_prompt;
                } else {
                    resultElement.textContent = 'Erreur lors de la génération du prompt';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                resultElement.textContent = `Erreur: ${error.message}`;
            });
        }
        
        // Événements
        templateSelect.addEventListener('change', () => {
            const templateId = templateSelect.value;
            
            // Mettre à jour l'URL pour inclure le template sélectionné
            if (templateId) {
                const url = new URL(window.location.href);
                url.searchParams.set('template_id', templateId);
                window.history.pushState({}, '', url);
            } else {
                const url = new URL(window.location.href);
                url.searchParams.delete('template_id');
                window.history.pushState({}, '', url);
            }
            
            loadTemplate(templateId);
        });
        
        generateButton.addEventListener('click', generatePrompt);
        
        // Charger le template initial si sélectionné
        const selectedTemplateId = templateSelect.value;
        if (selectedTemplateId) {
            loadTemplate(selectedTemplateId);
        }
    });
</script>
{% endblock %}
