services:
  collegue-app:
    build:
      context: .
      dockerfile: Dockerfile
    image: collegue-app:latest
    restart: always
    networks:
      - collegue-net
    environment:
      PYTHONUNBUFFERED: 1
      PORT: 4121
      MCP_TRANSPORT: http
      MCP_HOST: 0.0.0.0
    volumes:
      - .:/app
    env_file:
      - .env
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4122/_health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  keycloak:
    image: quay.io/keycloak/keycloak:26.3.2
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    env_file:
      - .env
    ports:
      - "4123:8080"
    networks:
      - collegue-net

  kc-provisioner:
    build:
      context: .
      dockerfile: docker/kc-provisioner/Dockerfile
    depends_on:
      keycloak:
        condition: service_started
    environment:
      KC_URL: http://keycloak:8080
      KC_REALM: ${KC_REALM:-master}
      KC_ADMIN_USERNAME: ${KEYCLOAK_ADMIN}
      KC_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      PROVISION_CLIENT_ID: ${PROVISION_CLIENT_ID:-windsurf-client}
      REQUIRED_SCOPE: ${OAUTH_REQUIRED_SCOPES:-mcp.read}
      WAIT_FOR_CLIENT_SECONDS: ${WAIT_FOR_CLIENT_SECONDS:-600}
    networks:
      - collegue-net
    restart: "no"

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    restart: always
    ports:
      - "8088:80"
    volumes:
      - nginx_logs:/var/log/nginx
    networks:
      - collegue-net
    depends_on:
      collegue-app:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


networks:
  collegue-net:
    driver: bridge

volumes:
  nginx_logs:
